<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Complyia • Data Clean & Prep (Pre‑Mapping)</title>
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .table-wrap { overflow: auto; max-height: 60vh; }
    th, td { white-space: nowrap; }
    thead th { position: sticky; top: 0; background: #f8fafc; z-index: 10; }
    tbody td.sticky-col, thead th.sticky-col { position: sticky; left: 0; background: #fff; z-index: 9; }
    thead th { user-select: none; }
    thead th.draggable { cursor: move; }
    thead th.th-drop-left { box-shadow: inset 3px 0 0 #10b981; }
    thead th.th-drop-right { box-shadow: inset -3px 0 0 #10b981; }
  </style>
  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-neutral-50 text-slate-800">
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-emerald-600 flex items-center justify-center text-white font-bold">C</div>
      <div>
        <h1 class="text-xl font-semibold">Complyia • Data Clean & Prep (Pre‑Mapping)</h1>
        <p class="text-sm text-slate-600">Load CSV/XLSX → clean formats → split/merge columns → export for mapping</p>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Import Row -->
    <section class="bg-white rounded-2xl shadow p-4 mb-6">
      <div class="flex flex-wrap items-center gap-3">
        <input id="file-input" type="file" accept=".csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" class="hidden" />
        <button id="pick-file" class="px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-700">Load CSV/XLSX</button>
        <div id="dropzone" class="flex-1 min-w-[260px] border-2 border-dashed border-slate-300 rounded-xl p-3 text-sm text-slate-600">Drag & drop file here</div>
        <span id="file-name" class="text-sm text-slate-500"></span>
        <div class="ml-auto flex items-center gap-2">
          <button id="export-csv" class="px-3 py-2 rounded-lg bg-slate-100 text-slate-800 text-sm hover:bg-slate-200" disabled>Export CSV</button>
          <button id="export-xlsx" class="px-3 py-2 rounded-lg bg-slate-100 text-slate-800 text-sm hover:bg-slate-200" disabled>Export XLSX</button>
          <button id="save-recipe" class="px-3 py-2 rounded-lg bg-slate-100 text-slate-800 text-sm hover:bg-slate-200" disabled>Save Recipe</button>
          <button id="load-recipe" class="px-3 py-2 rounded-lg bg-slate-100 text-slate-800 text-sm hover:bg-slate-200">Load Recipe</button>
          <input id="recipe-input" type="file" accept="application/json" class="hidden" />
        </div>
      </div>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- Left: Controls -->
      <section class="lg:col-span-1 space-y-6">
        <!-- Mapping Readiness / Guidance -->
        <div class="bg-white rounded-2xl shadow p-4">
          <h2 class="text-base font-semibold mb-2">Mapping Readiness</h2>
          <p class="text-xs text-slate-600 mb-3">These columns make downstream COA/GL → Tax mapping easier. Use the tools below to create/clean them.</p>
          <ul id="readiness-list" class="space-y-2 text-sm"></ul>
          <details class="mt-3">
            <summary class="text-xs text-slate-600 cursor-pointer">What is needed for column mapping?</summary>
            <ul class="list-disc pl-5 mt-2 text-xs text-slate-700 space-y-1">
              <li><strong>entity_id</strong> (or legal_entity_name)</li>
              <li><strong>erp_account_code</strong> (raw code)</li>
              <li><strong>natural_account</strong> (extracted)</li>
              <li><strong>account_name</strong></li>
              <li><strong>amount</strong> (numeric, decimal point)</li>
              <li><strong>currency</strong>, <strong>period</strong> (YYYY‑MM), <strong>posting_date</strong></li>
              <li><strong>source_system</strong>, <strong>file_name</strong> (optional lineage)</li>
            </ul>
          </details>
        </div>

        <div class="bg-white rounded-2xl shadow p-4">
          <h2 class="text-base font-semibold mb-3">Ask in English (beta)</h2>
          <div class="flex items-center gap-2">
            <input id="nl-input" class="flex-1 rounded-xl border border-slate-300 px-3 py-2 text-sm" placeholder='e.g., remove "column a"; merge "d" and "e" with "-" into "acct_path"; find values that have "?"' />
            <button id="nl-run" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm hover:bg-emerald-700">Apply</button>
            <select id="nl-mode" class="rounded-xl border border-slate-300 px-2 py-2 text-sm">
              <option value="local">Local parser</option>
              <option value="ai">AI</option>
            </select>
            <label class="flex items-center gap-1 text-xs text-slate-600">
              <input id="nl-explain" type="checkbox" class="rounded" /> Explain
            </label>
            <label class="flex items-center gap-1 text-xs text-slate-600">
              <input id="nl-dryrun" type="checkbox" class="rounded" /> Dry run
            </label>
          </div>
          <p class="text-xs text-slate-500 mt-2">Natural language commands translate to pipeline steps (shown below). You can still edit steps manually.</p>
          <div id="nl-msg" class="mt-2 text-xs text-slate-500 whitespace-pre-wrap"></div>
        </div>

        <!-- Transform Builder -->
        <div class="bg-white rounded-2xl shadow p-4">
          <h2 class="text-base font-semibold mb-3">Add Transform</h2>
          <div class="space-y-3">
            <div>
              <label class="block text-xs text-slate-600">Target Column</label>
              <select id="t-col" class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm"></select>
            </div>

            <div>
              <label class="block text-xs text-slate-600">Operation</label>
              <select id="t-op" class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm">
                <option value="trim">Trim</option>
                <option value="upper">Uppercase</option>
                <option value="lower">Lowercase</option>
                <option value="title">Title Case</option>
                <option value="replace">Replace (find → with)</option>
                <option value="coerce_number">Coerce → Number</option>
                <option value="coerce_date">Coerce → Date (ISO)</option>
                <option value="fill_empty">Fill empties</option>
                <option value="split">Split by delimiter</option>
                <option value="extract">Extract by RegExp</option>
                <option value="delete_col">Delete column</option>
                <option value="rename_col">Rename column</option>
                <option value="new_col_compute">New column: compute</option>
                <option value="merge_cols">Merge columns</option>
                <option value="math_col_const">Math: col ± × ÷ const</option>
                <option value="math_two_cols">Math: col1 ± × ÷ col2</option>
              </select>
            </div>

            <div id="t-params" class="grid grid-cols-1 gap-2"></div>

            <div class="flex items-center gap-2">
              <button id="add-step" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-700" disabled>Add Step</button>
              <button id="run-pipeline" class="px-3 py-2 rounded-xl bg-slate-800 text-white text-sm hover:bg-slate-900" disabled>Run</button>
              <label class="flex items-center gap-2 text-xs text-slate-600 ml-auto">
                <input id="enable-pipeline" type="checkbox" class="rounded" checked /> Enable
              </label>
            </div>
          </div>
        </div>

        <!-- Pipeline Steps -->
        <div class="bg-white rounded-2xl shadow p-4">
          <h2 class="text-base font-semibold mb-3">Pipeline</h2>
          <div class="flex items-center gap-2 mb-2">
            <button id="undo" class="px-2 py-1 rounded bg-slate-100 text-xs">Undo</button>
            <button id="redo" class="px-2 py-1 rounded bg-slate-100 text-xs">Redo</button>
            <div class="ml-auto text-xs text-slate-500" id="history-info"></div>
          </div>
          <ol id="pipeline" class="space-y-2 text-sm"></ol>
          <div id="nl-preview-wrap" class="mt-3 hidden">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-semibold">Preview</h3>
              <div class="flex items-center gap-2">
                <button id="apply-preview" class="px-2 py-1 rounded bg-emerald-600 text-white text-xs">Apply Preview</button>
                <button id="clear-preview" class="px-2 py-1 rounded bg-slate-100 text-xs">Clear</button>
              </div>
            </div>
            <ol id="nl-preview" class="space-y-2 text-sm mt-2"></ol>
          </div>
        </div>
      </section>

      <!-- Right: Data Table -->
      <section class="lg:col-span-3 bg-white rounded-2xl shadow p-4">
        <div class="flex items-center gap-3 mb-3">
          <div class="text-sm text-slate-600">Rows: <span id="row-count">0</span></div>
          <div class="ml-auto flex items-center gap-2">
            <input id="search" class="rounded-xl border border-slate-300 px-3 py-2 text-sm" placeholder="Search rows" />
            <button id="clear-edits" class="px-3 py-2 rounded-lg bg-slate-100 text-slate-800 text-sm hover:bg-slate-200" disabled>Reset to Original</button>
          </div>
        </div>

        <div id="table-wrap" class="table-wrap max-h-[60vh] border border-slate-200 rounded-xl">
          <table id="grid" class="w-full text-sm">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="flex items-center justify-between mt-3">
          <div class="text-xs text-slate-500" id="paging-info"></div>
          <div class="flex items-center gap-2">
            <button id="prev" class="px-3 py-1 rounded-lg bg-slate-100 text-sm" disabled>Prev</button>
            <input id="page" type="number" class="w-16 text-center rounded-lg border border-slate-300 text-sm px-2 py-1" value="1" min="1" />
            <button id="next" class="px-3 py-1 rounded-lg bg-slate-100 text-sm" disabled>Next</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    // ------- State -------
    let ORIGINAL = [];   // raw parsed rows
    let EDITED = [];     // working rows
    let COLUMNS = [];    // column names & order
    let PIPELINE = [];   // list of steps

    const PAGE_SIZE = 50;
    let CURRENT_PAGE = 1;

    // ------- DOM Helpers -------
    const $ = (id) => document.getElementById(id);
    const fileInput = $("file-input");
    const pickBtn = $("pick-file");
    const dropzone = $("dropzone");
    const fileNameEl = $("file-name");

    const exportCSVBtn = $("export-csv");
    const exportXLSXBtn = $("export-xlsx");
    const saveRecipeBtn = $("save-recipe");
    const loadRecipeBtn = $("load-recipe");
    const recipeInput = $("recipe-input");

    const tCol = $("t-col");
    const tOp = $("t-op");
    const tParams = $("t-params");
    const addStepBtn = $("add-step");
    const runBtn = $("run-pipeline");
    const enablePipeline = $("enable-pipeline");

    const pipelineList = $("pipeline");
    const undoBtn = $("undo");
    const redoBtn = $("redo");
    const historyInfo = $("history-info");
    const previewWrap = $("nl-preview-wrap");
    const previewList = $("nl-preview");
    const applyPreviewBtn = $("apply-preview");
    const clearPreviewBtn = $("clear-preview");
    let LAST_PREVIEW_STEPS = [];

    const thead = $("thead");
    const tbody = $("tbody");
    const rowCount = $("row-count");
    const pagingInfo = $("paging-info");
    const pageInput = $("page");
    const prevBtn = $("prev");
    const nextBtn = $("next");
    const searchInput = $("search");
    const clearEditsBtn = $("clear-edits");

    const readinessList = $("readiness-list");

    // NL controls
    const nlInput = $("nl-input");
    const nlRun = $("nl-run");
    const nlMode = $("nl-mode");
    const nlExplain = $("nl-explain");
    const nlDryrun = $("nl-dryrun");
    const nlMsg = $("nl-msg");

    // ------- Utils -------
    const clone = (x) => JSON.parse(JSON.stringify(x));
    const toTitle = (s) => s.replace(/\w\S*/g, (w) => w.charAt(0).toUpperCase() + w.substring(1).toLowerCase());

    // Build dynamic param controls for the selected op
    function renderParams() {
      const op = tOp.value;
      tParams.innerHTML = "";
      const add = (label, id, ph="", type="text") => {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `<label class="block text-xs text-slate-600">${label}</label>
          <input id="${id}" type="${type}" class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm" placeholder="${ph}">`;
        tParams.appendChild(wrapper);
      };
      const addSelect = (label, id, opts) => {
        const wrapper = document.createElement('div');
        const options = opts.map(o => `<option value="${o}">${o}</option>`).join('');
        wrapper.innerHTML = `<label class="block text-xs text-slate-600">${label}</label>
          <select id="${id}" class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm">${options}</select>`;
        tParams.appendChild(wrapper);
      };

      if (op === 'replace') {
        add('Find', 'p-find', 'e.g., \\s+');
        add('Replace With', 'p-repl', 'e.g., space');
        addSelect('Use RegExp?', 'p-regex', ['no','yes']);
      } else if (op === 'fill_empty') {
        add('Value for blanks', 'p-fill', 'e.g., 0');
      } else if (op === 'split') {
        add('Delimiter', 'p-delim', 'e.g., - or ,');
        add('New column base name', 'p-base', 'e.g., part');
        add('Max parts (optional)', 'p-max', 'e.g., 3', 'number');
      } else if (op === 'extract') {
        add('RegExp (capture group 1 used)', 'p-reg', 'e.g., (\\d{4,})');
        add('New column name', 'p-newname', 'e.g., natural_account');
      } else if (op === 'rename_col') {
        add('New column name', 'p-newname', 'e.g., natural_account');
      } else if (op === 'new_col_compute') {
        add('New column name', 'p-newname', 'e.g., amount_usd');
        add('Compute expression', 'p-expr', 'e.g., Number(amount) * 1.1');
      } else if (op === 'merge_cols') {
        add('Columns to merge (comma separated)', 'p-cols', 'e.g., company, dept, account');
        add('Delimiter', 'p-delim', 'e.g., -');
        add('New column name', 'p-newname', 'e.g., account_path');
      } else if (op === 'math_col_const') {
        addSelect('Operator', 'p-opr', ['+','-','*','/']);
        add('Constant', 'p-const', 'e.g., 100');
      } else if (op === 'math_two_cols') {
        add('Other column', 'p-col2', 'e.g., quantity');
        addSelect('Operator', 'p-opr', ['+','-','*','/']);
        add('New column name (optional)', 'p-newname', 'e.g., total');
      }
    }

    function refreshColumnSelect() {
      tCol.innerHTML = COLUMNS.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function updateReadiness() {
      const required = ['entity_id','legal_entity_name','erp_account_code','natural_account','account_name','amount','currency','period','posting_date'];
      readinessList.innerHTML = '';
      required.forEach((req) => {
        const has = COLUMNS.includes(req);
        const li = document.createElement('li');
        li.className = 'flex items-center gap-2';
        li.innerHTML = `<span class="inline-block w-2.5 h-2.5 rounded-full ${has ? 'bg-emerald-500' : 'bg-slate-300'}"></span>
                        <span class="${has ? 'text-slate-700' : 'text-slate-400'}">${req}</span>`;
        readinessList.appendChild(li);
      });
    }

    function renderTable() {
      rowCount.textContent = EDITED.length;
      // Header
      thead.innerHTML = '';
      const trh = document.createElement('tr');
      COLUMNS.forEach((c, idx) => {
        const th = document.createElement('th');
        th.className = `px-3 py-2 text-left text-xs font-semibold text-slate-700 border-b border-slate-200 ${idx===0 ? 'sticky-col' : ''}`;
        th.textContent = c;
        th.setAttribute('draggable','true');
        th.dataset.colIndex = idx;
        trh.appendChild(th);
      });
      thead.appendChild(trh);
      enableHeaderDrag();

      // Body with pagination
      const totalPages = Math.max(1, Math.ceil(EDITED.length / PAGE_SIZE));
      CURRENT_PAGE = Math.min(CURRENT_PAGE, totalPages);
      const start = (CURRENT_PAGE - 1) * PAGE_SIZE;
      const end = Math.min(start + PAGE_SIZE, EDITED.length);

      tbody.innerHTML = '';
      for (let i = start; i < end; i++) {
        const r = EDITED[i];
        const tr = document.createElement('tr');
        COLUMNS.forEach((c, idx) => {
          const td = document.createElement('td');
          td.className = `px-3 py-1 border-b border-slate-100 ${idx===0 ? 'sticky-col' : ''}`;
          const input = document.createElement('input');
          input.value = r[c] ?? '';
          input.className = 'w-full bg-transparent outline-none text-sm';
          input.addEventListener('change', (e) => { r[c] = e.target.value; });
          td.appendChild(input);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      }

      pageInput.value = CURRENT_PAGE;
      prevBtn.disabled = CURRENT_PAGE <= 1;
      nextBtn.disabled = CURRENT_PAGE >= totalPages;
      pagingInfo.textContent = `Page ${CURRENT_PAGE} / ${totalPages} (rows ${start+1}-${end})`;

      refreshColumnSelect();
      updateReadiness();
      toggleControls(true);
    }

    function toggleControls(hasData) {
      exportCSVBtn.disabled = !hasData;
      exportXLSXBtn.disabled = !hasData;
      saveRecipeBtn.disabled = !hasData;
      addStepBtn.disabled = !hasData;
      runBtn.disabled = !hasData;
      clearEditsBtn.disabled = !hasData;
    }

    // ------- File Loading (CSV or XLSX) -------
    async function handleFiles(files) {
      if (!files || !files[0]) return;
      const f = files[0];
      fileNameEl.textContent = f.name;
      const buf = await f.arrayBuffer();
      const wb = XLSX.read(buf, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { defval: '' , raw: false});
      const headerRow = XLSX.utils.sheet_to_json(ws, { header: 1 })[0] || [];
      COLUMNS = (headerRow.length ? headerRow : Object.keys(json[0] || {})).map(String);
      ORIGINAL = json;
      EDITED = clone(json);
      PIPELINE = [];
      renderTable();
      renderPipeline();
    }

    pickBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    ;['dragenter','dragover'].forEach(evt => dropzone.addEventListener(evt, (e) => { e.preventDefault(); dropzone.classList.add('bg-emerald-50'); }));
    ;['dragleave','drop'].forEach(evt => dropzone.addEventListener(evt, (e) => { e.preventDefault(); dropzone.classList.remove('bg-emerald-50'); }));
    dropzone.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files));

    // ------- Search -------
    searchInput.addEventListener('input', () => {
      const q = searchInput.value.toLowerCase();
      if (!q) { EDITED = clone(ORIGINAL); renderTable(); return; }
      EDITED = ORIGINAL.filter(r => COLUMNS.some(c => String(r[c] ?? '').toLowerCase().includes(q)));
      CURRENT_PAGE = 1; renderTable();
    });

    clearEditsBtn.addEventListener('click', () => { EDITED = clone(ORIGINAL); renderTable(); });

    // ------- Paging -------
    prevBtn.addEventListener('click', () => { CURRENT_PAGE = Math.max(1, CURRENT_PAGE - 1); renderTable(); });
    nextBtn.addEventListener('click', () => { CURRENT_PAGE += 1; renderTable(); });
    pageInput.addEventListener('change', () => { CURRENT_PAGE = Math.max(1, parseInt(pageInput.value||'1',10)); renderTable(); });

    // ------- Transform Params UI -------
    tOp.addEventListener('change', renderParams);

    // ------- Pipeline Apply -------
    runBtn.addEventListener('click', () => { if (!enablePipeline.checked) return; applyPipeline(); renderTable(); });

    function applyPipeline() {
      EDITED = clone(ORIGINAL);
      const enabledSteps = PIPELINE.filter(s => s.enabled !== false);
      enabledSteps.forEach(step => { EDITED = applyStep(EDITED, step); });
    }

    function safeNum(v) { const n = Number(String(v).replace(/[, ]+/g,'')); return Number.isFinite(n) ? n : NaN; }
    function doMath(a,b,opr){ switch(opr){ case '+': return a+b; case '-': return a-b; case '*': return a*b; case '/': return b===0? '': a/b; default: return a; } }

    function applyStep(rows, step) {
      const { op, col, params } = step;
      const out = rows.map(r => ({ ...r }));

      if (op === 'trim') {
        out.forEach(r => { if (r[col] != null) r[col] = String(r[col]).trim(); });
      } else if (op === 'upper') {
        out.forEach(r => { if (r[col] != null) r[col] = String(r[col]).toUpperCase(); });
      } else if (op === 'lower') {
        out.forEach(r => { if (r[col] != null) r[col] = String(r[col]).toLowerCase(); });
      } else if (op === 'title') {
        out.forEach(r => { if (r[col] != null) r[col] = toTitle(String(r[col])); });
      } else if (op === 'replace') {
        const find = params['p-find'] || '';
        const repl = params['p-repl'] || '';
        const isRegex = (params['p-regex'] === 'yes');
        const re = isRegex ? new RegExp(find, 'g') : null;
        out.forEach(r => {
          const s = String(r[col] ?? '');
          r[col] = isRegex ? s.replace(re, repl) : s.split(find).join(repl);
        });
      } else if (op === 'coerce_number') {
        out.forEach(r => { const n = safeNum(r[col]); r[col] = Number.isFinite(n) ? n : ''; });
      } else if (op === 'coerce_date') {
        out.forEach(r => { const d = new Date(r[col]); r[col] = isNaN(+d) ? '' : d.toISOString().slice(0,10); });
      } else if (op === 'fill_empty') {
        const fill = params['p-fill'] ?? '';
        out.forEach(r => { if (r[col] === '' || r[col] == null) r[col] = fill; });
      } else if (op === 'split') {
        const delim = params['p-delim'] ?? '';
        const base = params['p-base'] || (col + '_part');
        const max = parseInt(params['p-max']||'0',10) || undefined;
        out.forEach(r => {
          const parts = String(r[col] ?? '').split(delim);
          const use = max ? parts.slice(0, max) : parts;
          use.forEach((p, i) => { const name = `${base}_${i+1}`; if (!COLUMNS.includes(name)) COLUMNS.push(name); r[name] = p; });
        });
      } else if (op === 'extract') {
        try {
          const re = new RegExp(params['p-reg']||'');
          const newname = params['p-newname'] || (col + '_extracted');
          if (!COLUMNS.includes(newname)) COLUMNS.push(newname);
          out.forEach(r => { const m = String(r[col] ?? '').match(re); r[newname] = m && m[1] ? m[1] : ''; });
        } catch(e) { console.warn('Bad RegExp', e); }
      } else if (op === 'delete_col') {
        COLUMNS = COLUMNS.filter(c => c !== col);
        out.forEach(r => { delete r[col]; });
      } else if (op === 'rename_col') {
        const newname = params['p-newname'] || col;
        if (!COLUMNS.includes(newname)) {
          COLUMNS = COLUMNS.map(c => c === col ? newname : c);
          out.forEach(r => { r[newname] = r[col]; delete r[col]; });
        }
      } else if (op === 'new_col_compute') {
        const name = params['p-newname'] || 'computed';
        if (!COLUMNS.includes(name)) COLUMNS.push(name);
        out.forEach(r => { try { const ctx = { ...r, Number, String, Math, Date, Object }; r[name] = Function('ctx', 'with (ctx) { return ' + (params['p-expr']||'null') + '; }')(ctx); } catch(e) { r[name] = ''; } });
      } else if (op === 'merge_cols') {
        const cols = (params['p-cols']||'').split(',').map(s => s.trim()).filter(Boolean);
        const delim = params['p-delim'] || '';
        const newname = params['p-newname'] || 'merged';
        if (!COLUMNS.includes(newname)) COLUMNS.push(newname);
        out.forEach(r => { r[newname] = cols.map(c => r[c] ?? '').join(delim); });
      } else if (op === 'math_col_const') {
        const opr = params['p-opr'] || '+';
        const k = Number(params['p-const']||'0');
        out.forEach(r => { const a = safeNum(r[col]); if (!Number.isFinite(a)) { r[col] = ''; return; } r[col] = doMath(a, k, opr); });
      } else if (op === 'math_two_cols') {
        const col2 = params['p-col2'] || '';
        const opr = params['p-opr'] || '+';
        const newname = params['p-newname'] || col;
        if (!COLUMNS.includes(newname)) COLUMNS.push(newname);
        out.forEach(r => { const a = safeNum(r[col]); const b = safeNum(r[col2]); r[newname] = (Number.isFinite(a) && Number.isFinite(b)) ? doMath(a,b,opr) : ''; });
      }

      return out;
    }

    // ------- Natural Language Commands (local parser) -------
    function nlToStepsLocal(prompt){
      const NL_SYNONYMS = {
        'acct':'account', 'gl':'erp_account_code', 'glaccount':'erp_account_code', 'accountcode':'erp_account_code', 'accountnumber':'erp_account_code',
        'natural':'natural_account', 'entity':'entity_id', 'legal entity':'legal_entity_name', 'value':'amount', 'posted':'posting_date', 'date':'posting_date'
      };
      const p = prompt;
      const lower = p.toLowerCase();
      const quoted = extractQuoted(p);
      const steps = [];

      function findCol(name){
        if (!name) return null;
        const norm = s => String(s).toLowerCase().replace(/[^a-z0-9]/g,'');
        let cand = String(name).toLowerCase();
        if (NL_SYNONYMS[cand]) { cand = NL_SYNONYMS[cand]; }
        const q = norm(cand);
        let hit = COLUMNS.find(c => norm(c) === q);
        if (hit) return hit;
        hit = COLUMNS.find(c => norm(c).includes(q) || q.includes(norm(c)));
        if (hit) return hit;
        const qTokens = q.split(/_/).filter(Boolean);
        hit = COLUMNS.find(c => { const cn = norm(c); return qTokens.every(tok => cn.includes(tok)); });
        return hit || null;
      }

      // Remove / delete / drop column(s)
      if (lower.includes('remove') || lower.includes('delete') || lower.includes('drop')) {
        const targets = quoted.length ? quoted : COLUMNS.filter(c => lower.includes(c.toLowerCase()));
        const uniq = Array.from(new Set(targets.map(findCol).filter(Boolean)));
        uniq.forEach(col => steps.push({ op:'delete_col', col, params:{}, enabled:true }));
      }

      // Merge columns
      if (lower.includes('merge') || lower.includes('concatenate') || lower.includes('concat') || lower.includes('combine')) {
        let col1 = null, col2 = null;
        if (quoted.length >= 2) { col1 = findCol(quoted[0]); col2 = findCol(quoted[1]); }
        if ((!col1 || !col2) && quoted.length < 2) {
          const hits = COLUMNS.filter(c => lower.includes(c.toLowerCase()));
          if (hits.length >= 2) { col1 = hits[0]; col2 = hits[1]; }
        }
        let delim = '';
        if (lower.includes('with') && quoted.length >= 3) { delim = quoted[2]; }
        let newname = '';
        if (lower.includes(' into ') || lower.includes(' as ')) {
          newname = quoted[quoted.length - 1] || '';
        }
        if (col1 && col2) {
          const name = newname || `${col1}_${col2}`;
          steps.push({ op:'merge_cols', col: col1, params: { 'p-cols': `${col1}, ${col2}`, 'p-delim': delim, 'p-newname': name }, enabled:true });
        }
      }

      // Find values that have a "X"
      if (lower.includes('find') && lower.includes('values') && lower.includes('have') && quoted.length >= 1) {
        const needle = quoted[0];
        const name = `flag_contains_${needle.replace(/\\W+/g,'_')}`;
        const expr = `Object.values(ctx).some(v => String(v).includes("${needle.replace(/"/g, '\\"')}")) ? 1 : 0`;
        steps.push({ op:'new_col_compute', col: (COLUMNS[0] || ''), params: { 'p-newname': name, 'p-expr': expr }, enabled:true });
      }

      return steps;
    }

    function extractQuoted(str){
      const out = [];
      let i = 0;
      while ((i = str.indexOf("\"", i)) !== -1) {
        const j = str.indexOf("\"", i+1);
        if (j === -1) break;
        out.push(str.slice(i+1, j));
        i = j + 1;
      }
      return out;
    }

    // ------- AI-backed NL (server) -------
    const ALLOWED_OPS = ['trim','upper','lower','title','replace','coerce_number','coerce_date','fill_empty','split','extract','delete_col','rename_col','new_col_compute','merge_cols','math_col_const','math_two_cols'];
    const NL_SERVER_SYNONYMS = { 'acct':'account','gl':'erp_account_code','glaccount':'erp_account_code','accountcode':'erp_account_code','accountnumber':'erp_account_code','natural':'natural_account','entity':'entity_id','legal entity':'legal_entity_name','value':'amount','posted':'posting_date','date':'posting_date' };

    async function nlToStepsAI(prompt, opts={}) {
      if (!COLUMNS.length) return {steps:[], explanation:'No data loaded.'};
      const sample = ORIGINAL.slice(0, Math.min(10, ORIGINAL.length));
      const requiredCore = ['entity_id','legal_entity_name','erp_account_code','natural_account','account_name','amount','currency','period','posting_date'];
      const payload = {
        prompt,
        columns: COLUMNS,
        sample,
        allowed_ops: ALLOWED_OPS,
        synonyms: NL_SERVER_SYNONYMS,
        mapping_readiness: requiredCore,
        explain: !!opts.explain
      };
      const res = await fetch('/api/nl', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('Server returned ' + res.status);
      const data = await res.json();
      let steps = Array.isArray(data.steps) ? data.steps : [];
      steps = steps.filter(s => s && ALLOWED_OPS.includes(s.op));
      steps.forEach(s => { if (!s.params) s.params = {}; if (typeof s.enabled === 'undefined') s.enabled = true; });
      steps = steps.filter(s => {
        if (s.col && !COLUMNS.includes(s.col)) return false;
        if (s.op === 'merge_cols' && s.params['p-cols']) {
          const cols = s.params['p-cols'].split(',').map(x=>x.trim());
          return cols.every(c=>COLUMNS.includes(c));
        }
        return true;
      });
      return { steps, explanation: data.explanation || '' };
    }

    async function nlApply2(){
      if (!nlInput) return;
      const prompt = (nlInput.value || '').trim();
      if (!prompt) return;
      const mode = (nlMode && nlMode.value) || 'local';
      let steps = [];
      let explanation = '';
      if (mode === 'ai') {
        try {
          const out = await nlToStepsAI(prompt, { explain: nlExplain && nlExplain.checked });
          steps = out.steps; explanation = out.explanation || '';
        } catch (e) {
          explanation = 'AI error: ' + e.message + ' — falling back to local parser.';
          steps = nlToStepsLocal(prompt);
        }
      } else {
        steps = nlToStepsLocal(prompt);
      }
      if (!steps.length) { alert('Sorry, I could not understand that.'); return; }
      if (nlDryrun && nlDryrun.checked) {
        renderPreviewList(steps);
        if (nlMsg) nlMsg.textContent = (explanation || ('Planned ' + steps.length + ' step(s).'));
        return;
      }
      addStepsBatch(steps);
      applyPipeline();
      renderTable();
      renderPipeline();
      if (nlMsg) nlMsg.textContent = (explanation || ('Applied ' + steps.length + ' step(s).'));
    }

    if (nlRun) nlRun.addEventListener('click', nlApply2);
    if (nlInput) nlInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') nlApply2(); });

    // ------- History (Undo/Redo) -------
    let HISTORY = [];
    let FUTURE = [];
    function snapshot(){ return { pipeline: clone(PIPELINE), columns: clone(COLUMNS) }; }
    function pushHistory(){ HISTORY.push(snapshot()); if (HISTORY.length>100) HISTORY.shift(); FUTURE = []; updateHistoryInfo(); }
    function undo(){ if (!HISTORY.length) return; const s = HISTORY.pop(); FUTURE.push(snapshot()); PIPELINE = clone(s.pipeline); COLUMNS = clone(s.columns); renderPipeline(); applyPipeline(); renderTable(); updateHistoryInfo(); }
    function redo(){ if (!FUTURE.length) return; const s = FUTURE.pop(); HISTORY.push(snapshot()); PIPELINE = clone(s.pipeline); COLUMNS = clone(s.columns); renderPipeline(); applyPipeline(); renderTable(); updateHistoryInfo(); }
    function updateHistoryInfo(){ if (historyInfo) historyInfo.textContent = `undo:${HISTORY.length} redo:${FUTURE.length}`; }
    if (undoBtn) undoBtn.addEventListener('click', undo);
    if (redoBtn) redoBtn.addEventListener('click', redo);
    window.addEventListener('keydown', (e) => {
      const z = (e.key === 'z' || e.key === 'Z');
      if ((e.metaKey || e.ctrlKey) && z && !e.shiftKey) { e.preventDefault(); undo(); }
      if ((e.metaKey || e.ctrlKey) && z && e.shiftKey) { e.preventDefault(); redo(); }
    });

    function renderPipeline() {
      pipelineList.innerHTML = '';
      PIPELINE.forEach((step, idx) => {
        const li = document.createElement('li');
        li.className = 'border border-slate-200 rounded-xl p-2 flex items-start gap-2';
        const label = document.createElement('div');
        label.className = 'text-xs flex-1';
        label.textContent = `${idx+1}. ${step.op} on ${step.col}`;
        const btns = document.createElement('div');
        btns.className = 'flex items-center gap-2';
        const onoff = document.createElement('input');
        onoff.type = 'checkbox';
        onoff.checked = step.enabled !== false;
        onoff.addEventListener('change', () => { pushHistory(); step.enabled = onoff.checked; applyPipeline(); renderTable(); updateHistoryInfo(); });
        const del = document.createElement('button');
        del.textContent = 'Delete';
        del.className = 'px-2 py-1 rounded bg-slate-100 text-xs';
        del.addEventListener('click', () => { pushHistory(); PIPELINE.splice(idx,1); renderPipeline(); applyPipeline(); renderTable(); updateHistoryInfo(); });
        btns.appendChild(onoff); btns.appendChild(del);
        li.appendChild(label); li.appendChild(btns);
        pipelineList.appendChild(li);
      });
      updateHistoryInfo();
    }

    function addStep(step) { pushHistory(); PIPELINE.push(step); renderPipeline(); }
    function addStepsBatch(steps){ if (!steps || !steps.length) return; pushHistory(); steps.forEach(s=>PIPELINE.push(s)); renderPipeline(); }

    // ------- NL Preview -------
    function renderPreviewList(steps){
      if (!previewWrap || !previewList) return;
      LAST_PREVIEW_STEPS = steps.slice();
      previewList.innerHTML = '';
      steps.forEach((s,i)=>{
        const li = document.createElement('li');
        li.className = 'border border-emerald-200 rounded-xl p-2 bg-emerald-50/50';
        li.textContent = `${i+1}. ${s.op} ${s.col ? ('on ' + s.col) : ''}`;
        previewList.appendChild(li);
      });
      previewWrap.classList.remove('hidden');
    }
    function clearPreview(){ LAST_PREVIEW_STEPS = []; if (previewList) previewList.innerHTML = ''; if (previewWrap) previewWrap.classList.add('hidden'); }
    if (applyPreviewBtn) applyPreviewBtn.addEventListener('click', ()=>{ if (!LAST_PREVIEW_STEPS.length) return; addStepsBatch(LAST_PREVIEW_STEPS); clearPreview(); applyPipeline(); renderTable(); renderPipeline(); });
    if (clearPreviewBtn) clearPreviewBtn.addEventListener('click', clearPreview);

    // ------- Export -------
    exportCSVBtn.addEventListener('click', () => {
      const ws = XLSX.utils.json_to_sheet(EDITED, { header: COLUMNS });
      const csv = XLSX.utils.sheet_to_csv(ws);
      downloadString(csv, 'text/csv;charset=utf-8;', 'cleaned.csv');
    });

    exportXLSXBtn.addEventListener('click', () => {
      const ws = XLSX.utils.json_to_sheet(EDITED, { header: COLUMNS });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Cleaned');
      const out = XLSX.write(wb, { type: 'array', bookType: 'xlsx' });
      downloadBlob(new Blob([out], { type: 'application/octet-stream' }), 'cleaned.xlsx');
    });

    saveRecipeBtn.addEventListener('click', () => {
      const recipe = JSON.stringify({ pipeline: PIPELINE, columns: COLUMNS }, null, 2);
      downloadString(recipe, 'application/json', 'recipe.json');
    });

    loadRecipeBtn.addEventListener('click', () => recipeInput.click());
    recipeInput.addEventListener('change', async (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      const txt = await f.text();
      const data = JSON.parse(txt);
      if (Array.isArray(data.columns)) COLUMNS = data.columns;
      if (Array.isArray(data.pipeline)) PIPELINE = data.pipeline;
      renderPipeline(); renderTable();
    });

    function downloadString(str, type, filename) {
      const blob = new Blob([str], { type });
      downloadBlob(blob, filename);
    }
    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click();
      setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 0);
    }

    // ------- Column Drag & Reorder -------
    let DRAG_FROM_INDEX = null;
    function enableHeaderDrag() {
      const ths = thead.querySelectorAll('th');
      ths.forEach((th, idx) => {
        th.classList.add('draggable');
        th.setAttribute('draggable','true');
        th.dataset.colIndex = idx;
        th.removeEventListener('dragstart', handleDragStart);
        th.removeEventListener('dragover', handleDragOver);
        th.removeEventListener('dragleave', handleDragLeave);
        th.removeEventListener('drop', handleDrop);
        th.removeEventListener('dragend', handleDragEnd);
        th.addEventListener('dragstart', handleDragStart);
        th.addEventListener('dragover', handleDragOver);
        th.addEventListener('dragleave', handleDragLeave);
        th.addEventListener('drop', handleDrop);
        th.addEventListener('dragend', handleDragEnd);
      });
    }
    function handleDragStart(e){
      DRAG_FROM_INDEX = Number(e.currentTarget.dataset.colIndex || 0);
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', String(DRAG_FROM_INDEX));
    }
    function handleDragOver(e){
      e.preventDefault();
      const th = e.currentTarget;
      const rect = th.getBoundingClientRect();
      const leftHalf = e.clientX < rect.left + rect.width/2;
      th.classList.toggle('th-drop-left',  leftHalf);
      th.classList.toggle('th-drop-right', !leftHalf);
      e.dataTransfer.dropEffect = 'move';
    }
    function handleDragLeave(e){
      const th = e.currentTarget;
      th.classList.remove('th-drop-left','th-drop-right');
    }
    function handleDragEnd(){
      thead.querySelectorAll('th').forEach(th => th.classList.remove('th-drop-left','th-drop-right'));
    }
    function handleDrop(e){
      e.preventDefault();
      const th = e.currentTarget;
      const idx = Number(th.dataset.colIndex);
      const rect = th.getBoundingClientRect();
      const insertLeft = e.clientX < rect.left + rect.width/2;
      let toIndex = idx + (insertLeft ? 0 : 1);
      if (DRAG_FROM_INDEX == null) return;
      if (toIndex > DRAG_FROM_INDEX) toIndex--; // account for removal shift
      if (toIndex === DRAG_FROM_INDEX) { handleDragEnd(); return; }
      moveInArray(COLUMNS, DRAG_FROM_INDEX, toIndex);
      DRAG_FROM_INDEX = null;
      renderTable();
    }
    function moveInArray(arr, from, to){ const [el] = arr.splice(from,1); arr.splice(to,0,el); }

    // Initial UI setup
    renderParams();
  </script>
</body>
</html>
